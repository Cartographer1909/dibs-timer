// Torn API configuration
const API_URL = "https://api.torn.com/faction/1117?selections=rankedwars&key=wI5WFpMW2K3YnLNx&comment";

// Reference to the table body
const targetsTable = document.getElementById('targetsTable');

// Track timers for each target
const countdowns = {};

// Fetch data from the Torn API
async function fetchTornData() {
    try {
        const response = await fetch(API_URL);
        const data = await response.json();

        if (data.error) {
            console.error("API Error:", data.error);
            return;
        }

        populateTable(data.rankedwars);
    } catch (error) {
        console.error("Fetch Error:", error);
    }
}

// Populate table with ranked war data
function populateTable(rankedWars) {
    targetsTable.innerHTML = ""; // Clear existing rows

    const targets = Object.values(rankedWars.participants || {});

    targets.forEach((participant, index) => {
        const row = document.createElement('tr');
        row.id = `row-${index}`;

        // Name cell
        const targetCell = document.createElement('td');
        targetCell.textContent = participant.name;

        // Status dropdown cell
        const statusCell = document.createElement('td');
        const dropdown = document.createElement('select');
        dropdown.innerHTML = `<option value="FREE">FREE</option><option value="DIBS">DIBS</option>`;
        dropdown.addEventListener('change', () => handleStatusChange(index, dropdown));
        statusCell.appendChild(dropdown);

        // Timer cell
        const timerCell = document.createElement('td');
        const timerDisplay = document.createElement('div');
        timerDisplay.textContent = participant.hospital_timestamp
            ? formatHospitalTime(participant.hospital_timestamp)
            : "N/A";
        timerDisplay.className = 'timer';
        timerCell.appendChild(timerDisplay);

        // Append cells to the row
        row.appendChild(targetCell);
        row.appendChild(statusCell);
        row.appendChild(timerCell);

        // Append row to the table
        targetsTable.appendChild(row);

        // Initialize countdown for this row if hospital timer exists
        if (participant.hospital_timestamp) {
            startHospitalCountdown(participant.hospital_timestamp, timerDisplay);
        }
    });
}

// Start hospital timer countdown
function startHospitalCountdown(endTimestamp, timerDisplay) {
    const endTime = endTimestamp * 1000; // Convert to milliseconds

    const interval = setInterval(() => {
        const currentTime = new Date().getTime();
        const remainingTime = endTime - currentTime;

        if (remainingTime <= 0) {
            clearInterval(interval);
            timerDisplay.textContent = "Ready";
        } else {
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        }
    }, 1000);
}

// Format hospital time for display
function formatHospitalTime(hospitalTimestamp) {
    const remainingTime = hospitalTimestamp * 1000 - new Date().getTime();
    if (remainingTime <= 0) return "Ready";

    const minutes = Math.floor(remainingTime / 60000);
    const seconds = Math.floor((remainingTime % 60000) / 1000);
    return `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
}

// Handle status dropdown change
function handleStatusChange(index, dropdown) {
    const selectedValue = dropdown.value;
    const timerDisplay = document.querySelector(`#row-${index} .timer`);

    if (selectedValue === "DIBS") {
        startCountdown(index, timerDisplay, dropdown);
    } else {
        resetCountdown(index, timerDisplay);
    }
}

// Start dibs countdown
function startCountdown(index, timerDisplay, dropdown) {
    if (countdowns[index]) clearInterval(countdowns[index]);

    const endTime = new Date().getTime() + 5 * 60 * 1000; // 5 minutes from now
    countdowns[index] = setInterval(() => {
        const currentTime = new Date().getTime();
        const remainingTime = endTime - currentTime;

        if (remainingTime <= 0) {
            clearInterval(countdowns[index]);
            timerDisplay.textContent = "5:00";
            dropdown.value = "FREE"; // Reset status to FREE
        } else {
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        }
    }, 1000);
}

// Reset dibs countdown
function resetCountdown(index, timerDisplay) {
    clearInterval(countdowns[index]);
    timerDisplay.textContent = "5:00";
}

// Fetch data on page load
fetchTornData();
